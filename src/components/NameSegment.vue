<template lang="pug">
span.name-segment(:data-segment-types="dataMarkdownType" :data-tag-color="dataTagColor" :data-tag-name="dataTagName")
  template(v-if="segment.isText && segment.content")
    //- Name markdown
    span.markdown(v-if="segment.markdown")
      template(v-for="markdown in segment.markdown")
        template(v-if="markdown.type === 'text'")
          span {{markdown.content}}
        template(v-else-if="markdown.type === 'link'")
          a(@mouseup="updateShouldCancel" @click="openUrl($event, escapedUrl(markdown.result[2]))" :href="escapedUrl(markdown.result[2])") {{markdown.result[1]}}
        template(v-else-if="markdown.type === 'bold'")
          strong {{markdown.content}}
        template(v-else-if="markdown.type === 'h1'")
          h1 {{markdown.content}}
        template(v-else-if="markdown.type === 'h2'")
          h2 {{markdown.content}}
        template(v-else-if="markdown.type === 'h3'")
          h3 {{markdown.content}}
        template(v-else-if="markdown.type === 'emphasis'")
          em {{markdown.content}}
        template(v-else-if="markdown.type === 'strikethrough'")
          del {{markdown.content}}
        template(v-else-if="markdown.type === 'codeBlock'")
          pre {{markdown.content}}
        template(v-else-if="markdown.type === 'code'")
          code {{markdown.content}}
    //- Name results list
    template(v-if="!segment.markdown")
      span(v-if="search")
        NameMatch(:name="segment.content" :indexes="matchIndexes(segment.content)")
      span(v-else) {{segment.content}}
  //- Tags
  span.badge.button-badge(
    v-if="segment.isTag"
    :style="{backgroundColor: segment.color}"
    :class="{ active: currentSelectedTag.name === segment.name }"
    @click.left="showTagDetailsIsVisible($event, segment)"
    @touchend.stop="showTagDetailsIsVisible($event, segment)"
    @keyup.stop.enter="showTagDetailsIsVisible($event, segment)"
    :data-tag-id="segment.id"
    :data-tag-name="segment.name"
  ) {{segment.name}}
  //- Link
  a.link-badge-url(v-if="segment.isLink" :href="segment.name")
    span.badge.button-badge.link-badge(
      :class="{ active: currentSelectedLink.name === segment.name }"
      @click.left.prevent="showLinkDetailsIsVisible($event, segment)"
      @touchend.stop.prevent="showLinkDetailsIsVisible($event, segment)"
      @keyup.stop.enter="showLinkDetailsIsVisible($event, segment)"
    )
      template(v-if="segmentSpace(segment)")
        User(v-if="segmentSpace(segment).users" :user="segmentSpace(segment).users[0]" :isClickable="false")
        span {{segmentSpace(segment).name || segment.content || segment.name }}
        img.icon.private(v-if="spaceIsPrivate(segmentSpace(segment))" src="@/assets/lock.svg")
      template(v-else)
        span {{segment.name}}
  //- File
  span.badge.secondary(v-if="segment.isFile")
    img.icon(src="@/assets/file.svg")
    span {{segment.name}}
</template>

<script>
import User from '@/components/User.vue'
import NameMatch from '@/components/NameMatch.vue'
import utils from '@/utils.js'

import fuzzy from '@/libs/fuzzy.js'

let shouldCancel = false

export default {
  name: 'NameSegment',
  components: {
    User,
    NameMatch
  },
  props: {
    segment: Object,
    search: String
  },
  computed: {
    currentSelectedTag () { return this.$store.state.currentSelectedTag },
    currentSelectedLink () { return this.$store.state.currentSelectedLink },
    dataMarkdownType () {
      if (this.segment.isTag) { return 'tag' }
      if (this.segment.isLink) { return 'link' }
      if (!this.segment.markdown) { return 'text' }
      let markdown = this.segment.markdown.filter(item => Boolean(item.content))
      const segmentIsEmpty = !utils.arrayExists(markdown)
      if (segmentIsEmpty) { return 'text' }
      let types = markdown.map(item => item.type)
      types = utils.arrayToString(types)
      return types
    },
    dataTagColor () {
      if (!this.segment.isTag) { return }
      return this.segment.color
    },
    dataTagName () {
      if (!this.segment.isTag) { return }
      return this.segment.name
    }
  },
  methods: {
    matchIndexes (name) {
      if (!name) { return [] }
      const options = {
        pre: '',
        post: ''
      }
      const filtered = fuzzy.filter(this.search, [name], options)
      if (filtered.length) {
        return filtered[0].indices
      } else {
        return []
      }
    },
    showTagDetailsIsVisible (event, tag) {
      this.$emit('showTagDetailsIsVisible', { event, tag })
    },
    showLinkDetailsIsVisible (event, link) {
      this.$emit('showLinkDetailsIsVisible', { event, link })
    },
    spaceIsPrivate (space) {
      if (!space.privacy) { return }
      return space.privacy === 'private'
    },
    segmentSpace (segment) {
      if (segment.space) { return segment.space }
      const spaceId = utils.spaceIdFromUrl(segment.name)
      const space = this.$store.getters.cachedOrOtherSpaceById(spaceId)
      return space
    },
    escapedUrl (url) {
      if (url.includes('javascript:')) {
        return null
      }
      return url
    },
    updateShouldCancel (event) {
      shouldCancel = this.$store.state.preventDraggedCardFromShowingDetails
    },
    openUrl (event, url) {
      this.$store.dispatch('closeAllDialogs', 'NameSegment.openUrl')
      if (this.$store.state.currentUser.shouldOpenLinksInNewTab) {
        window.open(url) // opens url in new tab
        event.preventDefault()
      }
      if (shouldCancel) {
        event.preventDefault()
        shouldCancel = false
      }
      // open url natively
    }
  }
}
</script>

<style lang="stylus">
.name-segment
  > .button-badge
    vertical-align 1px
  .markdown
    word-break break-word
    white-space pre-wrap
    a
      color var(--text-link)
      text-decoration underline
      text-decoration-thickness 1px // for firefox
      -webkit-touch-callout none // for ios
      &:hover
        text-decoration none
    strong
      font-weight normal
      color var(--primary-background)
      background-color var(--primary)
      border-radius 3px
    pre
      font-weight normal
      background-color var(--secondary-active-background)
      border-radius 3px
      margin 0
      white-space pre-wrap
    code
      font-weight normal
      background-color var(--secondary-active-background)
      border-radius 3px
      margin-right 0
    h1
      font-family var(--serif-font)
      font-size 22px
      font-weight bold
      margin 0
      display inline-block
    h2
      font-family var(--serif-font)
      font-weight normal
      font-size 20px
      margin 0
      display inline-block
    h3
      font-family var(--serif-font)
      font-weight normal
      font-size 16px
      margin 0
      display inline-block

  .link-badge-url
    color var(--primary)
    text-decoration none
</style>

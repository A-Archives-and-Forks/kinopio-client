<template lang="pug">
dialog.narrow.space-picker(v-if="visible" :open="visible" @click.left.stop ref="dialog" :style="{top: dialogPositionTop}")
  template(v-if="parentIsCardDetails && !currentUserIsSignedIn")
    section
      p
        span To link to a space,
        span.badge.info you need to Sign Up or In
      button(@click.left.stop="triggerSignUpOrInIsVisible") Sign Up or In
  template(v-if="(parentIsCardDetails && currentUserIsSignedIn) || !parentIsCardDetails")
    // New Space
    section.options(v-if="shouldShowNewSpace")
      .row
        button(@click="toggleNewSpaceIsVisible" :class="{ active: newSpaceIsVisible }")
          img.icon(src="@/assets/add.svg")
          span New Space
      template(v-if="newSpaceIsVisible")
        .row
          .button-wrap
          input(placeholder="name" ref="newSpaceName" v-model="newSpaceName" @keyup.space.prevent @keyup.escape.stop="toggleNewSpaceIsVisible" @keyup.stop @keyup.enter.exact="createNewSpace")
        .row
          button(@click="createNewSpace")
            span Create New Space
            Loader(:visible="isLoadingNewSpace")
    //- Daily Journal
    section.options(v-if="shouldShowDailyJournalSpace")
      .row
        button(@click="selectOrCreateDailyJournalSpace")
          img.icon(v-if="!todayJournalSpace" src="@/assets/add.svg")
          MoonPhase(:moonPhase="moonPhase.name")
          span Daily Journal

    // Type to Search
    section.info-section(v-if="parentIsCardDetails && !search")
      p
        img.icon.search(src="@/assets/search.svg")
        span Type to search spaces {{search}}
    // Space List
    section.results-section
      Loader(:visible="loading")
      SpaceList(
        v-if="filteredSpaces.length"
        :hideFilter="hideFilter"
        :spaces="filteredSpaces"
        :showUserIfCurrentUserIsCollaborator="showUserIfCurrentUserIsCollaborator"
        :selectedSpace="selectedSpace"
        @selectSpace="selectSpace"
        :search="search"
        @focusBeforeFirstItem="handleFocusBeforeFirstItem"
      )
      .error-container(v-if="!filteredSpaces.length && !loading")
        User(:user="activeUser" :isClickable="false" :key="activeUser.id")
        span(v-if="activeUserIsCurrentUser && search") has no spaces matching {{search}}
        span(v-else-if="activeUserIsCurrentUser") has no spaces
        span(v-else) has no public spaces
</template>

<script>
import scrollIntoView from '@/scroll-into-view.js'
import Loader from '@/components/Loader.vue'
import words from '@/data/words.js'
import newSpace from '@/data/new.json'
import cache from '@/cache.js'
import utils from '@/utils.js'
import moonphase from '@/moonphase.js'
import MoonPhase from '@/components/MoonPhase.vue'

import { nanoid } from 'nanoid'
import fuzzy from '@/libs/fuzzy.js'

import { defineAsyncComponent } from 'vue'
const User = defineAsyncComponent({
  loader: () => import('@/components/User.vue')
})
const SpaceList = defineAsyncComponent({
  loader: () => import('@/components/SpaceList.vue')
})

export default {
  name: 'SpacePicker',
  components: {
    Loader,
    SpaceList,
    User,
    MoonPhase
  },
  props: {
    visible: Boolean,
    selectedSpace: Object,
    shouldExcludeCurrentSpace: Boolean,
    userSpaces: Array,
    user: Object,
    loading: Boolean,
    showUserIfCurrentUserIsCollaborator: Boolean,
    parentIsCardDetails: Boolean,
    position: Object,
    search: String,
    cursorPosition: Number,
    shouldShowNewSpace: Boolean,
    shouldShowDailyJournalSpace: Boolean
  },
  mounted () {
    this.moonPhase = moonphase()
  },
  data () {
    return {
      isLoading: false,
      spaces: [],
      newSpaceIsVisible: false,
      newSpaceName: '',
      isLoadingNewSpace: false
    }
  },
  computed: {
    activeUser () {
      const currentUser = this.$store.state.currentUser
      return this.user || currentUser
    },
    hideFilter () {
      if (this.parentIsCardDetails) {
        return true
      } else {
        return false
      }
    },
    activeUserIsCurrentUser () {
      const currentUser = this.$store.state.currentUser
      return this.activeUser.id === currentUser.id
    },
    dialogPositionTop () {
      if (this.position) {
        return this.position.top + 'px'
      } else {
        return undefined
      }
    },
    filteredSpaces () {
      if (!this.parentIsCardDetails) { return this.spaces }
      let spaces = this.spaces.filter(space => {
        return space.name !== this.search
      })
      const options = {
        pre: '',
        post: '',
        extract: (item) => {
          let name = item.name || ''
          return name
        }
      }
      const filtered = fuzzy.filter(this.search, spaces, options)
      spaces = filtered.map(item => {
        let result = utils.clone(item.original)
        result.matchIndexes = item.indices
        return result
      })
      return spaces
    },
    currentUserIsSignedIn () { return this.$store.getters['currentUser/isSignedIn'] },
    todayJournalSpace () {
      const today = utils.journalSpaceName()
      const todaySpace = this.spaces.find(space => {
        if (space.moonPhase) {
          const createdAt = utils.journalSpaceDateFromName(space.name)
          if (!createdAt) { return }
          return createdAt === today
        } else {
          return false
        }
      })
      return todaySpace
    }
  },
  methods: {
    handleFocusBeforeFirstItem () {
      if (this.newSpaceIsVisible) { return }
      this.toggleNewSpaceIsVisible()
    },
    excludeCurrentSpace () {
      if (!this.shouldExcludeCurrentSpace) { return }
      const currentSpace = this.$store.state.currentSpace
      this.spaces = this.spaces.filter(space => space.id !== currentSpace.id)
    },
    updateSpaces () {
      if (this.userSpaces) {
        this.spaces = this.userSpaces
      } else {
        this.spaces = cache.getAllSpaces()
        this.updateWithRemoteSpaces()
      }
      this.excludeCurrentSpace()
    },
    async updateWithRemoteSpaces () {
      if (!this.spaces.length) {
        this.isLoading = true
      }
      const spaces = await this.$store.dispatch('api/getUserSpaces')
      this.isLoading = false
      if (!spaces) { return }
      this.spaces = spaces
      this.excludeCurrentSpace()
    },
    selectSpace (space) {
      this.$emit('selectSpace', space)
    },
    scrollIntoView () {
      const element = this.$refs.dialog
      const isTouchDevice = this.$store.state.isTouchDevice
      scrollIntoView.scroll(element, isTouchDevice)
    },
    triggerSignUpOrInIsVisible () {
      this.$store.dispatch('closeAllDialogs', 'SpacePicker.triggerSignUpOrInIsVisible')
      this.$store.commit('triggerSignUpOrInIsVisible')
    },
    toggleNewSpaceIsVisible () {
      this.newSpaceIsVisible = !this.newSpaceIsVisible
      if (this.newSpaceIsVisible) {
        this.$nextTick(() => {
          this.focusNewSpaceNameInput()
        })
      }
    },
    async createNewSpace () {
      if (this.isLoadingNewSpace) { return }
      if (!this.newSpaceName) {
        this.newSpaceName = words.randomUniqueName()
      }
      const currentUser = this.$store.state.currentUser
      const user = { id: currentUser.id, color: currentUser.color, name: currentUser.name }
      this.isLoadingNewSpace = true
      let space = utils.clone(newSpace)
      space.name = this.newSpaceName
      space.id = nanoid()
      space.url = utils.url({ name: space.name, id: space.id })
      space.userId = user.id
      space.users.push(user)
      space.cards = []
      space.connections = []
      space.connectionTypes = []
      space = utils.spaceDefaultBackground(space, currentUser)
      space = cache.updateIdsInSpace(space)
      console.log('ðŸšš create new space', space)
      if (this.currentUserIsSignedIn) {
        await this.$store.dispatch('api/createSpace', space)
      }
      this.isLoadingNewSpace = false
      this.selectSpace(space)
    },
    async selectOrCreateDailyJournalSpace () {
      if (this.todayJournalSpace) {
        this.isLoadingNewSpace = false
        this.selectSpace(this.todayJournalSpace)
        return
      }
      const currentUser = this.$store.state.currentUser
      const space = utils.journalSpace(null, currentUser)
      console.log('ðŸšš create new journal space', space)
      if (this.currentUserIsSignedIn) {
        await this.$store.dispatch('api/createSpace', space)
      }
      this.isLoadingNewSpace = false
      this.selectSpace(space)
    },

    clearState () {
      this.newSpaceIsVisible = false
      this.newSpaceName = words.randomUniqueName()
    },
    focusNewSpaceNameInput () {
      const element = this.$refs.newSpaceName
      if (!element) { return }
      element.focus()
      element.setSelectionRange(0, 99999)
    }
  },
  watch: {
    visible (visible) {
      this.$nextTick(() => {
        this.clearState()
        if (visible) {
          this.updateSpaces()
          this.scrollIntoView()
          this.isLoading = this.loading
        }
      })
    },
    userSpaces: {
      handler (userSpaces) {
        this.updateSpaces()
      },
      deep: true
    }
  }
}
</script>

<style lang="stylus">
.space-picker
  .results-section
    padding-top 4px
    @media(max-height 700px)
      max-height 50vh
    @media(max-height 400px)
      max-height 40vh
  .error-container
    padding 4px
    display flex
    align-items center
    .user
      margin-right 6px
  .info-section
    padding-bottom 4px
    border-top 0
  section.options
    margin 0 !important
    width 100%
    padding-bottom 5px
    border-top none
</style>
